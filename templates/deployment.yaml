apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "ioc-chart.release" . }}
  labels:
    {{- include "ioc-chart.labels" . | nindent 4 }}
spec:
  replicas: 1
  serviceName: {{ include "ioc-chart.release" . }}
  selector:
    matchLabels:
      {{- include "ioc-chart.selectorLabels" . | nindent 8 }}
  template:
    metadata:
      labels:
        {{- include "ioc-chart.selectorLabels" . | nindent 8 }}
    spec:
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}
      serviceAccountName: {{ .Values.serviceAccountName | default .Values.serviceAccountNameOverride | quote }}
      hostNetwork: {{ .Values.hostNetwork }}
      initContainers:
        {{- if .Values.gitRepoConfig.url }}
      - name: init-container-git
        image: baltig.infn.it:4567/epics-containers/container-init
        command:
          - sh
          - -c
          - |
            id=$(id)
            cd /tmp
            echo "ID $id cloning: {{ .Values.gitRepoConfig.url }} {{ .Values.gitRepoConfig.path }} revision {{ .Values.gitRepoConfig.branch }} "
            if [ -d temp-config ]; then
              rm -rf temp-config
            fi
            if [ -n "{{ .Values.gitRepoConfig.branch }}" ]; then
              git clone -b {{ .Values.gitRepoConfig.branch }} {{ .Values.gitRepoConfig.url }} --recurse-submodules temp-config
            else
              git clone {{ .Values.gitRepoConfig.url }} --recurse-submodules temp-config
            fi
            ls -latr
            if [ -d temp-config/{{ .Values.gitRepoConfig.path}} ]; then
              if [ "{{ .Values.gitRepoConfig.path }}" == "." ]; then
                mv temp-config/* /tmp/
              else
                mv temp-config/{{ .Values.gitRepoConfig.path}}/* /tmp/
                rm -rf temp-config
              fi
            else
              mv temp-config/* /tmp/
            fi
            ls /tmp
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - name: config-volume
            mountPath: /tmp
        {{ end }}
      terminationGracePeriodSeconds: 15
      volumes:
        {{- if .Values.runtimeClaim }}
        - name: runtime-volume
          persistentVolumeClaim:
            claimName: {{ .Values.runtimeClaim }}
        {{- end }}
        {{- if .Values.opisClaim }}
        - name: opis-volume
          persistentVolumeClaim:
            claimName: {{ .Values.opisClaim }}
        {{- end }}
        {{- if .Values.nfsv2TftpClaim }}
        - name: nfsv2-tftp-volume
          persistentVolumeClaim:
            claimName: {{ .Values.nfsv2TftpClaim }}
        {{- end }}
        - name: autosave-volume
          persistentVolumeClaim:
            {{- if .Values.autosave }}
            claimName: {{ .Values.autosave }}
            {{- else }}
            claimName: {{ include "ioc-chart.release" . }}-autosave
            {{- end }}
        {{- if .Values.dataVolume.pvc }}
        - name: data-volume
          persistentVolumeClaim:
            claimName: {{ include "ioc-chart.release" . }}-data
        {{- end }}
        {{- if .Values.gitRepoConfig.url }}
        - name: config-volume
          persistentVolumeClaim:
            claimName: {{ include "ioc-chart.release" . }}-gitconfig
        {{- else}}
        - name: config-volume
          configMap:
            name: {{ include "ioc-chart.release" . }}
        {{- end }}
  volumeClaimTemplates:
    {{- if .Values.dataVolume.pvc }}
    - metadata:
        name: data-volume
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: {{ .Values.dataVolume.size | default "1Gi" }}
    {{- end }}
  updateStrategy:
    type: RollingUpdate
  {{- if .Values.useAffinity }}
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: beamline
                operator: In
                values:
                  - {{ .Values.beamline }}
          topologyKey: "kubernetes.io/hostname"
  {{- end }}
  tolerations:
    - key: nodetype
      operator: Equal
      value: {{ .Values.beamline }}
      effect: NoSchedule
